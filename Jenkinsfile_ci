pipeline {
    agent any

    tools{
      maven 'maven_3.8'
     // SonarQube Scanner 'ibt-sonarqube_5'
    }

    stages{

      stage('Github Checkout'){
        steps{
           git branch: 'feature-uzoma', changelog: false, credentialsId: 'github_creds_uzoma', poll: false, url: 'https://github.com/IBT-learning/ibt-maven.git'


        }

      }

       stage('List Content') {
         steps{
            sh 'ls -lrt'
            }

       }

       stage('Validate') {
                steps{
                   withMaven(maven: 'maven_3.9.3') {
                       sh 'mvn --version'
                       sh 'mvn validate'
                   }
               }
       }

       stage('Sonarqube Scan') {
            environment{
                 sonarScan = tool 'ibt-sonarqube_4.8'
              }
                    steps{
                      withSonarQubeEnv(credentialsId: 'student-sonar-token', installationName: 'IBT sonarqube') {
                         sh "${env.sonarScan}/bin/sonar-scanner"
                      }
                    }
       }

       stage('Compile') {
                     steps{
                          withMaven(maven: 'maven_3.8') {
                              sh 'mvn --version'
                              sh 'mvn compile'
                          }
                     }
              }

       stage('Test') {
                steps {
                    sh 'mvn --version'
                    sh 'mvn test'
                }
       }

       stage('Package') {
                 steps {
                           sh 'mvn --version'
                           sh 'mvn package'
                 }
       }

       stage('Dependency Scan') {
                   steps {
                      dependencyCheck additionalArguments: '''
                                          -o './'
                                          -s './'
                                          -f 'ALL'
                                          --prettyPrint''', odcInstallation: 'dependency-chec'

                              dependencyCheckPublisher pattern: 'dependency-check-report.xml'
                  }
       }

       stage('Upload to Artifactory') {
                   steps {
                           withCredentials([file(credentialsId: 'settings_uzoma', variable: 'mvn_settings_uzoma')]) {
                              sh 'mvn deploy -s $mvn_settings_uzoma'
                           }
                   }

       }

        stage('Upload to Artifactory (config)') {
                   steps {
                        configFileProvider([configFile(fileId: 'artifactory-settings', variable: 'mvn_settings_config')]) {
                           sh 'mvn deploy -s $mvn_settings_config'
                        }

                   }
        }

        //stage('Deploy to Dev') {
                 steps {
                     script{
                        def remote = [name: 'dev', host: '54.172.108.231', allowAnyHosts: 'true'
                      withCredentials([usernamePassword(credentialsId: 'ubuntu_tomcat_creds_uzoma', passwordVariable: 'password', usernameVariable: 'username')]) {
                        remote.user = username
                        remote.password = password
                        sshPut remote: remote, from: 'target/ibt-maven/7.0-SNAPSHOT.jar', into: '/opt/tomcat/webapp'
                      }
                    }


                }

       }


    } // end of stages

} // end of pipeline