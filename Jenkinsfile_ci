pipeline{

    agent any
    tools{
        maven 'maven_3.9.3'
    }
    stages{
        stage('github checkout'){
            steps{
                checkout scmGit(branches: [[name: '*/jan2024franklinv1']], extensions: [], userRemoteConfigs: [[credentialsId: 'franklin-githubacc', url: 'https://github.com/IBT-learning/ibt-maven']])

            }
        }// end of stage
        stage('list files'){
            steps{
               sh ' ls -lrt'

            }
        }// end of stage
         stage('validate'){
            steps{
               withMaven( maven: 'maven_3.9.3') {
                   sh 'mvn --version'
                   sh 'mvn validate'

               }

            }

         }// end of stage
         stage('sonarqube scan'){
         environment{
            sonarScan= tool 'ibt-sonarqube_4.8'
         }
                    steps{
                      withSonarQubeEnv(credentialsId: 'student-sonar-token', installationName: 'IBT sonarqube') {
                        sh "${env.sonarScan}/bin/sonar-scanner"
                      }

                    }
                  }// end of stage
         stage('compile'){
           steps{
             sh 'mvn --version'
             sh 'mvn test'

           }
         }// end of stage
         stage('package'){
           steps{
            sh 'mvn --version'
            sh 'mvn package'
           }
         }// end of stage

         stage('DependencyScan'){
                              steps{
                                  dependencyCheck additionalArguments: '''
                                      -o "./"
                                      -s "./"
                                      -f "ALL"
                                      --prettyPrint ''', odcInstallation: 'dependency-check'
                                  dependencyCheckPublisher pattern: 'dependency-check-report.xml'
                              }
                          }

         stage('upload artefacts'){
                    steps{
                     withCredentials([file(credentialsId: 'settings_franklin', variable: 'setings_franklin')]) {
                         sh 'mvn  deploy -s $setings_franklin'
                     }
                                        }
                  }// end of stage
         stage('deploy to dev'){
                             steps{
                                    script {
                                                def userInput = input message: 'Proceed with this step?',
                                                                     ok: 'Submit',
                                                                     parameters: [choice(choices: ['Approve', 'Reject'], name: 'approvalStatus')]

                                                if (userInput['approvalStatus'] == 'Approve') {
                                                    // Build and deploy logic if approved



                                                                                            def remote= [name: 'dev-server', host: '68.183.32.165', allowAnyHosts: true]
                                                                                            withCredentials([usernamePassword(credentialsId: 'serveronyia', passwordVariable: 'password', usernameVariable: 'username')]) {
                                                                                                remote.user= username
                                                                                                remote.password= password
                                                                                                sshPut remote: remote, from: 'target/ibt-maven-2.0-SNAPSHOT.jar', into: '/opt/tomcat/apps'
                                                                                            }

                                                }
                                                else {
                                                    // Handle rejection or cancellation
                                                    echo 'Build rejected. Aborting...'
                                                    currentBuild.result = 'ABORTED' // Set build result to aborted
                                                }


                                    }
                              }

                           }// end of stage
    }// end of stages
}// end of pipeline